{#
/**
 * @file
 * Text with featured media.
 *
 * Variant "left_simple" is used by default.
 */
#}

{% set variant = variant|default('left_simple') %}
{% set text = text|render %}
{% set video_ratio = video_ratio|replace({':': '-'}) %}
{% set allowed_values = ['16-9','4-3','3-2','1-1'] %}
{% if video_ratio not in allowed_values %}
  {# Rely on ECL. #}
  {% set video_ratio = '' %}
{% endif %}

{# We consider the text position while ECL needs the media position, so we need to reverse the values. #}
{% if 'right' in variant %}
  {% set _position = 'left' %}
{% else %}
  {% set _position = 'right' %}
{% endif %}

{% if link %}
  {% set link_highlighted = 'featured' in variant ? true : false %}
  {% set _icon = get_link_icon(link.path, 'm') %}
  {% if _icon['name'] == 'corner-arrow' %}
    {% set _icon = _icon|merge({
      'name': 'arrow-left',
      'transform': 'flip-horizontal',
    }) %}
  {% endif %}
  {{ dump(_icon['name']) }}
  {% set call_to_action_link = {
    link: {
      type: 'standalone',
      label: link.label,
      path: link.path,
      icon_position: 'after'
    },
    icon: _icon,
  }%}
{% endif %}

{% if image or video or animation %}
    {% if image %}
      {% set _media_container = {
        'picture': {
          'img': {
            'src': image.src,
            'alt': image.alt,
          },
        },
        'description': caption,
      } %}
    {% elseif video %}
      {% set _media_container = {
        'embedded_media': video,
        'ratio': video_ratio,
        'description': caption,
      } %}
    {% elseif animation.sources %}
      {% set _animation = animation %}
      {# We need to use src_type instead of type to avoid getting render
        arrays due to using type. #}
      {% set _sources = [] %}
      {% for _source in _animation.sources %}
        {% set _sources = _sources|merge([_source|merge({
          type: _source.src_type
        })]) %}
      {% endfor %}
      {% set _animation = _animation|merge({
        sources: _sources
      }) %}
      {% set _media_container = {
        'video': _animation,
        'autoplay': true,
        'description': caption,
        'icon_path': ecl_icon_path,
      } %}
    {% endif %}
{% endif %}

{% if expandable is defined and expandable.content is not empty %}
  {% if expandable.hidden == true %}
    {% set aria_describedby_id = expandable.id|default('text-featured-media-' ~ random(100)) %}
    {% set extra_attributes = [
      {
        'name': 'aria-describedby',
        'value': aria_describedby_id,
      }
    ] %}
    <div id="{{aria_describedby_id}}" hidden class="text-featured-media-hidden-content">{{ expandable.content }}</div>
  {% else %}
    {% set _media_container = _media_container|merge({
      'expandable': {
        'id': expandable.id|default('text-featured-media-' ~ random(10)),
        'button': {
          label: expandable.label_collapsed,
          variant: 'secondary',
          icon: {
            name: 'corner-arrow',
            transform: 'rotate-180',
            size: 'm',
            path: ecl_icon_path,
          }
        },
        label_expanded: expandable.label_expanded|default('Expanded'|t),
        label_collapsed: expandable.label_collapsed|default('Collapsed'|t),
        content: expandable.content,
      }
    }) %}
  {% endif %}
{% endif %}

{% if title %}
  <div class="ecl">
    <h2 class='ecl-u-type-heading-2'>{{ title }}</h2>
  </div>
{% endif %}

{% include '@ecl-twig/featured-item' with {
  type: highlighted == true ? 'highlight' : '',
  color_mode: color_mode|default(''),
  title: text_title|default(''),
  description: text|default(''),
  link: call_to_action_link,
  media_container: _media_container|default([]),
  position: _position,
  link_highlighted: link_highlighted|default(false),
  extra_attributes: extra_attributes|default([]),
  extra_classes: extra_classes|default(''),
} %}
